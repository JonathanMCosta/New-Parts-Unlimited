# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- terraform
pool:
  name: Azure Pipelines
  vmImage: 'windows-latest'

variables: 
  name: 

stages:
- stage: CI 

  variables:
    BuildConfiguration : 'Release'

  jobs:
  - job: Build
    steps:
    # - task: DotNetCoreCLI@2
    #   displayName: Restore
    #   inputs:
    #     command: restore
    #     projects: '**/*.csproj'
    # - task: DotNetCoreCLI@2
    #   displayName: Build
    #   inputs:
    #     projects: '**/*.csproj'
    #     arguments: '--configuration $(BuildConfiguration)'
    # - task: DotNetCoreCLI@2
    #   displayName: Test
    #   inputs:
    #     command: test
    #     projects: '**/*[Tt]ests/*.csproj'
    #     arguments: '--configuration $(BuildConfiguration)'
    # - task: DotNetCoreCLI@2
    #   displayName: Publish
    #   inputs:
    #     command: publish
    #     publishWebProjects: True
    #     arguments: '--configuration $(BuildConfiguration) --output $(build.artifactstagingdirectory)'
    #     zipAfterPublish: True
    - task: CopyFiles@2
      displayName: 'Copy Terraform files to artifacts'
      inputs:
        SourceFolder: Terraform
        TargetFolder: '$(build.artifactstagingdirectory)/Terraform'
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact'
      inputs:
        PathtoPublish: '$(build.artifactstagingdirectory)'
      condition: succeededOrFailed()

- stage: dev
  pool:
    name: Azure Pipelines
    vmImage: 'windows-latest'
  
  variables:
    terraformstoragerg: 'terraformrg'
    terraformstorageaccount: 'terraformstorage8323a84e'
    appservicename: 'pulterraformweb8323a84e'
    appserviceplan: 'PULTerraformplan'
    storagekey: 'PipelineWillGetThisValueRuntime'

  jobs:
  - job: Deploy
    steps:
    #Your build pipeline references an undefined variable named ‘Parameters.ConnectedServiceName’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
    #Your build pipeline references an undefined variable named ‘Parameters.WebAppKind’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
    #Your build pipeline references an undefined variable named ‘Parameters.WebAppName’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
    - download: current
      artifact: drop
    - task: AzureCLI@1
      displayName: 'Azure CLI to deploy required Azure resources'
      inputs:
        azureSubscription: 'esx - Sub'
        scriptLocation: 'inlineScript'
        inlineScript: |
          # this will create Azure resource group
          call az group create --location westus --name $(terraformstoragerg)
          call az storage account create --name $(terraformstorageaccount) --resource-group $(terraformstoragerg) --location westus --sku Standard_LRS
          call az storage container create --name terraform --account-name $(terraformstorageaccount)
          call az storage account keys list -g $(terraformstoragerg) -n $(terraformstorageaccount)
    - task: AzurePowerShell@3
      displayName: 'Azure PowerShell script to get the storage key'
      inputs:
        azureSubscription: 'esx - Sub'
        ScriptType: 'InlineScript'
        Inline: |
          # Using this script we will fetch storage key which is required in terraform file to authenticate backend storage account     
          $key=(Get-AzureRmStorageAccountKey -ResourceGroupName $(terraformstoragerg) -AccountName $(terraformstorageaccount)).Value[0]
          Write-Host "##vso[task.setvariable variable=storagekey]$key"
        azurePowerShellVersion: 'LatestVersion'
    - task: replacetokens@3
      displayName: Replace tokens in terraform file
      inputs:
        targetFiles: '**/*.tf'
        escapeType: none
        tokenPrefix: '__'
        tokenSuffix: '__'
    - task: TerraformInstaller@0
      inputs:
        terraformVersion: '0.12.3'

    - task: TerraformTaskV1@0
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)/_Terraform-CI/drop/Terraform'
        backendServiceArm: 'esx - Sub'
        backendAzureRmResourceGroupName: '$(terraformstoragerg)'
        backendAzureRmStorageAccountName: '$(terraformstorageaccount)'
        backendAzureRmContainerName: 'terraform'
        backendAzureRmKey: 'terraform.tfstate'

    - task: TerraformTaskV1@0
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(System.DefaultWorkingDirectory)/_Terraform-CI/drop/Terraform'
        environmentServiceNameAzureRM: 'esx - Sub'

    - task: TerraformTaskV1@0
      inputs:
        provider: 'azurerm'
        command: 'apply'
        workingDirectory: '$(System.DefaultWorkingDirectory)/_Terraform-CI/drop/Terraform'
        commandOptions: '-auto-approve'
        environmentServiceNameAzureRM: 'esx - Sub'

#     - task: AzureRmWebAppDeployment@4
#       displayName: 'Deploy Azure App Service'
#       inputs:
#         ConnectionType: 'AzureRM'
#         azureSubscription: 'esx - Sub'
#         appType: 'webApp'
#         WebAppName: '$(System.StageDisplayName)newpartsunlimited-mdo'
#         packageForLinux: '$(Pipeline.Workspace)/**/*.zip'

# - stage: hmg
#   pool:
#     name: Azure Pipelines
#     vmImage: 'windows-latest'
  
#   jobs:
#   - job: Deploy
#     steps:
#     #Your build pipeline references an undefined variable named ‘Parameters.ConnectedServiceName’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
#     #Your build pipeline references an undefined variable named ‘Parameters.WebAppKind’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
#     #Your build pipeline references an undefined variable named ‘Parameters.WebAppName’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
#     - download: current
#       artifact: drop
#     - task: AzureRmWebAppDeployment@4
#       displayName: 'Deploy Azure App Service'
#       inputs:
#         ConnectionType: 'AzureRM'
#         azureSubscription: 'esx - Sub'
#         appType: 'webApp'
#         WebAppName: '$(System.StageDisplayName)newpartsunlimited-mdo'
#         packageForLinux: '$(Pipeline.Workspace)/**/*.zip'